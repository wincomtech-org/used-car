<!DOCTYPE html>
<html lang="en">

<head>
    <title>购物车 - {$site_info.site_name|default=''}</title>
    <meta name="keywords" content="{$site_info.site_seo_keywords|default=''}" />
    <meta name="description" content="{$site_info.site_seo_description|default=''}">
    <!-- 服务商城css -->
    <link href='__TMPL__/public/assets/css/shop.css' type="text/css" rel="stylesheet">
    <include file="public@head" />
    <style type="text/css">
        .btn_cart{display:block;padding: 15px 5px;width: 100%}
    </style>
</head>

<body>
    <!-- 头部 -->
    <include file="public@header" />
    <!-- 热门资讯 -->
    <section class="person">
        <div class="">
            <ul class="brash main">
                <li>当前位置：</li>
                <li class=""><a href="{:url('Index/index')}">服务商城</a></li>
                <li class="active"><a>购物车</a></li>
            </ul>

            <!-- 电脑端 -->
            <form action="{:url('user/Shop/buyCart')}" method="post" id="cartForm-pc">
            <div class="shops_order carts main">
                <div class='fixedD'>
                    <table class='shops-order-tab'>
                        <thead>
                            <tr>
                                <th class='col-pro-img ma-0'>
                                    <label class='all-sel'>
                                        <input type="checkbox" class='all-sel-inp'> 全选</label>
                                </th>
                                <th class='col-pro ma-1'>商品信息</th>
                                <th class='col-pro ma-2'>市场价</th>
                                <th class='col-pro ma-3'>数量</th>
                                <th class='col-pro ma-4'>单价</th>
                                <th class='col-pro ma-5'>小计</th>
                                <th class='col-pro ma-6'>操作</th>
                            </tr>
                        </thead>
                    </table>
                    
                    <foreach name="carts" item="vo">
                    <table class='shops-order-tab tableSel'>
                        <tbody class='order-list'>
                            <tr class='order-list-tit'>
                                <td class='ma-0'>
                                    <input type="checkbox" name="cartol[{$vo.id}][id]" value="{$vo.id}" class='sel-checkbox'>
                                </td>
                                <td class='ma-1' colspan='5'>

                                </td>
                                <td class='ma-6'>编辑</td>
                            </tr>
                            <tr class='order-list-con'>
                                <td class='ma-0'></td>
                                <td class='ma-1'>
                                    <div class="order-img">
                                        <a href="{:url('Post/details','id='.$vo.goods_id)}">
                                            <empty name="vo.thumbnail">
                                            <img src="__TMPL__/public/assets/images/default-thumbnail_160x109.png" alt="">
                                            <else/>
                                            <img src="{:url('thumbUrl',['img'=>urlencode($vo.thumbnail),'w'=>160,'h'=>109])}" alt="">
                                            </empty>
                                        </a>
                                    </div>
                                    <div class="order-intro">
                                        <div class='order-trade-name'>
                                            <a href="{:url('Post/details','id='.$vo.goods_id)}">{$vo.goods_name}</a>
                                        </div>
                                        <div class='order-attributes'>
                                            <span>规格：{$vo.spec_vars}</span>
                                        </div>
                                    </div>
                                </td>
                                <td class='ma-2'>￥ <span class='original'>{$vo.market_price}</span></td>
                                <td class='ma-3'>
                                    <div class="amout-num">
                                        <span class='btn-reduce'>-</span>
                                        <span class='amoutNum'><input type="text" name="cartol[{$vo.id}][number]" value="{$vo.number}" class='amoutNum-inp' readonly></span>
                                        <span class='btn-add'>+</span>
                                    </div>
                                </td>
                                <td class='ma-4'>
                                    <span class='unit-price'>
                                        {$vo.price}
                                    </span>
                                </td>
                                <td class='ma-5'>
                                    <span class='tot-pri'>{$vo.number*$vo.price}</span>
                                </td>
                                <td class='ma-6'>
                                    <div class="order-state group-a">
                                        <a href="javascript:void(0);" class='btn-style backg-red remove-order'>删除</a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    </foreach>
                </div>

                <table class='shops-order-tab shops-order-op' style='background-color:#f5f5f5;'>
                    <thead>
                        <tr>
                            <th class='col-pro-img ma-0'>
                                <label class='all-sel'>
                                    <input type="checkbox" class='all-sel-inp'>全选</label>
                            </th>
                            <th class='col-pro ma-1' style='text-align:left;'><a class='red-color all-del' href='javascript:void(0);'>删除</a></th>
                            <th class='col-pro ma-2'></th>
                            <th class='col-pro ma-3'>已选商品 <span><i class='totalNum'>2</i> 件</span></th>
                            <th class='col-pro'>合计（不含运费）<b class='orage-color totalPri'>1500.00</b>元</th>
                            <th class='col-pro ma-6 gray-btn'>
                                <!-- <a style="display:block;" href="{:url('user/Shop/buyCart')}">结算</a> -->
                                <button onclick="btnHandle('pc');" class="btn_cart" type="button">结算</button>
                            </th>
                        </tr>
                    </thead>
                </table>
            </div>
            </form>


            <!-- 手机端 -->
            <form action="{:url('user/Shop/buyCart')}" method="post" id="cartForm-wap">
            <div class="shops_order_m carts">
                <div class='fixedD1'>
                    <foreach name="carts" item="vo">
                    <div class='shops-order-m-div tableSel'>
                        <div class='order-list'>
                            <dl class='order-list-tit'>
                                <dd class='mess'>
                                    <label class='all-sel'>
                                        <input type="checkbox" name="cartol[{$vo.id}][id]" value="{$vo.id}" class='sel-checkbox'>
                                    </label>
                                    <span class="order-goods"></span>
                                </dd>
                                <dd class='states'><a class='editor'>编辑</a></dd>
                            </dl>
                        </div>
                        <div class='order-list-con'>
                            <div class='order-mess'>
                                <div class="order-img">
                                    <a href="{:url('Post/details','id='.$vo.goods_id)}">
                                        <empty name="vo.thumbnail">
                                        <img src="__TMPL__/public/assets/images/default-thumbnail_160x109.png" alt="">
                                        <else/>
                                        <img src="{:url('thumbUrl',['img'=>urlencode($vo.thumbnail),'w'=>160,'h'=>109])}" alt="">
                                        </empty>
                                    </a>
                                </div>
                                <div class="order-intro">
                                    <div class='order-trade-name'>
                                        <a href="{:url('Post/details','id='.$vo.goods_id)}">{$vo.goods_name}</a>
                                    </div>
                                    <div class='order-attributes'>
                                        <span>规格：{$vo.spec_vars}</span>
                                    </div>
                                </div>
                                <div class="item-pay">
                                    <p class='unit-price'>{$vo.price}</p>
                                    <p class='tot-pri'>{$vo.number*$vo.price}</p>
                                    <p class='amount_mobel small'>{$vo.number}</p>
                                </div>
                                <!-- mobile  -->
                                <div class="item-editor" style='display:none;'>
                                    <div class="amout-num">
                                        <span class='btn-reduce'>-</span>
                                        <span class='amoutNum'><input type="text" name="cartol[{$vo.id}][number]" value='{$vo.number}' class='amoutNum-inp' readonly></span>
                                        <span class='btn-add'>+</span>
                                    </div>
                                    <div class="opeat-btn backg-red">
                                        <span>删除</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </foreach>
                </div>
                <div class='ti'></div>
                <ul class="shops_order_m_total clearfix shops-order-op1">
                    <li>
                        <label class='all-sel'>
                            <input type="checkbox" class='all-sel-inp'>全选</label>
                    </li>
                    <li>
                        合计<b class='orage-color totalPri'>0</b>元
                    </li>
                    <li class='rt'>
                        <!-- <a style="display:block;width: 100%" href="{//:url('user/Shop/buyCart')}">
                            <span>结算</span>
                        </a> -->
                        <button onclick="btnHandle('wap');" class="btn_cart" type="button">结算</button>
                    </li>
                </ul>
            </div>
            </form>
        </div>
    </section>
    <!-- 底部 -->
    <include file="public@footer" />
    <include file="public@scripts" />
</body>
<include file="public@morejs" />
<script type="text/javascript">
// 提交数据到 user/Shop/buyCart
function btnHandle(o) {
    // 判断是否checkbox
    var check = $(".sel-checkbox").is(":checked");
    console.log(check)
    if (check) {
        $('#cartForm-'+o).submit();
    } else {
        alert('请点击选择要购买的商品');
    }
}



// 购物车
// 删除
$('.remove-order').click(function() {
    if (confirm('确认删除？')) {
        $(this).parents('.tableSel').remove();
        totalNum();
        totalPri();
        scrollFix(x, y);
    }
});
// 全部删除
$('.all-del').click(function() {
    if (confirm('确认删除？')) {
        $(this).parents('.carts').find('.tableSel').remove();
        totalNum();
        totalPri();
        scrollFix(x, y);
    }
});

// 增加数量
$('.btn-add').click(function() {
    $(this).siblings('.amoutNum').children('.amoutNum-inp').val()
    var amount = $(this).siblings('.amoutNum').children('.amoutNum-inp').val();
    var unit_price = $(this).parent().parent().siblings().children('.unit-price').html();
    var tot_pri = $(this).parent().parent().siblings().children('.tot-pri').html();
    var original = $(this).parents('table').find('.original').text();
    var price_difference = parseFloat(original) - parseFloat(unit_price);
    price_difference = price_difference.toFixed(2);

    amount++;
    tot_pri = parseFloat(amount * unit_price).toFixed(2);
    // 手机端
    $(this).parents('.shops-order-m-div').find('.item-pay .amount_mobel').text(amount);

    $(this).siblings('.amoutNum').children('.amoutNum-inp').val(amount);
    $(this).parent().parent().siblings().children('.tot-pri').html(tot_pri);
    totalNum();
    totalPri();
})

// 减少数量
$('.btn-reduce').click(function() {
    $(this).siblings('.amoutNum').children('.amoutNum-inp').val()
    var amount = $(this).siblings('.amoutNum').children('.amoutNum-inp').val();
    var unit_price = $(this).parent().parent().siblings().children('.unit-price').html();
    var tot_pri = $(this).parent().parent().siblings().children('.tot-pri').html();
    var original = $(this).parents('table').find('.original').text();
    var price_difference = parseFloat(original) - parseFloat(unit_price);
    price_difference = price_difference.toFixed(2);
    favourable = price_difference * parseInt(amount);

    if (amount > 1) {
        amount--;
        tot_pri = parseFloat(amount * unit_price).toFixed(2);
        $(this).siblings('.amoutNum').children('.amoutNum-inp').val(amount);
        $(this).parent().parent().siblings().children('.tot-pri').html(tot_pri);
        // 手机端
        $(this).parents('.shops-order-m-div').find('.item-pay .amount_mobel').text(amount);
    } else {

    }
    totalNum();
    totalPri();
});

// 全选
$('.all-sel-inp').click(function() {
    var _this = $(this);
    if ($(this).attr('checked')) {
        $('.all-sel-inp').prop('checked', true);
        _this.parents('.carts').find('.sel-checkbox').prop('checked', true);
        _this.parents('.carts').find('.sel-checkbox').parents('.tableSel').addClass('sel');
        totalNum()
        totalPri();
        // favourable();
    } else {
        $('.all-sel-inp').prop('checked', false);
        _this.parents('.carts').find('.sel-checkbox').prop('checked', false);
        _this.parents('.carts').find('.totalNum').html(parseInt(0))
        _this.parents('.carts').find('.totalPri').html(parseInt(0))
    }
})

// 单选
$('.sel-checkbox').click(function() {
    if (!$(this).prop('checked')) {
        $('.all-sel-inp').prop('checked', false);
        $(this).parents('.tableSel').removeClass('sel')
    } else {
        $(this).parents('.tableSel').addClass('sel')
    }
    totalNum();
    totalPri();
})

// 总数量
function totalNum(obj) {
    // 被选中数量
    if ($('.tableSel').hasClass('sel')) {
        var tab_inp = $('.sel .amoutNum-inp').map(function() {
            return $(this).val();
        }).get();
        var sum = tab_inp.reduce(function(x, y) { return parseFloat(x) + parseFloat(y) })
        $('.totalNum').html(sum)
    } else {
        $('.totalNum').html(parseInt(0))
    }
}

// 总价
function totalPri() {
    if ($('.tableSel').hasClass('sel')) {
        var tab_span = $('.sel .tot-pri').map(function() {
            return $(this).text();
        }).get();
        var totPrice = tab_span.reduce(function(x, y) { return parseFloat(x) + parseFloat(y) });
        totPrice = parseFloat(totPrice).toFixed(2)
        $('.totalPri').html(totPrice)
    } else {
        $('.totalPri').html(parseInt(0))
    }
}


// 手机端购物车
$('.editor').click(function() {
    $(this).parents('.shops-order-m-div').find('.item-editor').toggle();
})

if (screen.width > 1023) {
    var x = $('.shops-order-op');
    var y = $('.fixedD');
} else {
    var x = $('.shops-order-op1');
    var y = $('.fixedD1');
}
// 购物车按钮固定
$(function() {
    scrollFix(x, y)
    $(window).scroll(function(event) {
        scrollFix(x, y)
    })
})

// 结算栏固定
function scrollFix(obj, b) {
    var fixD = b.height();
    var fixDT = b.offset().top;

    var docH = $(window).height();
    var docTop = $(document).scrollTop();
    var divtop = obj.offset().top;
    var divBto = obj.offset().bottom;
    var divH = obj.height();
    var hh = fixDT + fixD - docH - docTop,
        docTop;

    if (hh > 0) {
        // alert(1)
        obj.addClass('fixedTab');
    } else {
        obj.removeClass('fixedTab');
    }
}
</script>
</html>